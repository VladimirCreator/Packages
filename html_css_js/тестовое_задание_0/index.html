<!DOCTYPE html>

<html lang='en'>
  <head>
    <meta charset='UTF-8'>

    <title>
      Vladimir Leonidovich Petrov
    </title>

    <meta name='viewport' content='width=device-width, initial-scale=1.0'>

    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM' crossorigin='anonymous'>
  </head>

  <body class='container-xxl p-4 bg-light'>
    <div class='table-responsive'>
      <table class='table table-striped align-middle text-center'>
        <thead>
          <tr class='table-dark'>
          </tr>
        </thead>

        <tbody>
        </tbody>
      </table>
    </div>

    <canvas id='interceptedRequests' class='bg-light-subtle'>
    </canvas>

    <div id='applicationForm' class='modal'>
      <div class='modal-dialog modal-fullscreen-sm-down'>
        <div class='modal-content'>
          <div class='modal-header'>
            <h1 class='fs-3'>
              Новое приложение
            </h1>
          </div>

          <div class='modal-body'>
            <ul class='nav nav-tabs'>
              <li class='nav-item'>
                <a class='nav-link active' href='#'>Основные</a>
              </li>
            </ul>

            <form class='vstack gap-3 px-1 py-3'>
            </form>
          </div>

          <div class='modal-footer'>
            <button id='cancelButton' class='btn btn-secondary' type='button' data-bs-dismiss='modal'>
              Отмена
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js' integrity='sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz' crossorigin='anonymous'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

    <script src="./UIImage.js">
    </script>

    <script>
      class Application {

        app_id;
        app_name;
        policy_id;
        agent_js_config;
        correlations_config;

        constructor(plain) {
          if (plain instanceof Application) {
            this.agent_js_config = plain.agent_js_config;
            this.app_id = plain.app_id;
            this.correlations_config = plain.correlations_config;
            this.app_name = plain.app_name;
            this.policy_id = plain.policy_id;

            return;
          }
          else if (plain instanceof Object) {
            this.agent_js_config = plain.agent_js_configs;
            this.app_id = plain.ids;
            this.correlations_config = plain.correlations_configs;
            this.app_name = plain.names;
            this.policy_id = plain.policy_ids;
          }
        }

      }
    </script>

    <script>
      // MARK:- `UIApplication`
      class UIApplication {

        // MARK: Properties

        applications = [];
        #observers = [];

        #domain = "http://checkstatus.website:8099";
        #headers = { "Content-Type": "application/json;charset=utf-8" };

        // MARK: Constructors

        constructor(flag = true) {
          if (flag) {
            throw new Error();
          }
        }

        // MARK: Methods

        attachObserver(observer) {
          this.#observers.push(observer);
        }

        detachObserver(observer) {
          this.#observers = this.#observers.filter(candidate => candidate !== observer);
        }

        notifyObservers(object) {
          this.#observers.forEach(observer => observer.applicationDidFetch(object));
        }

        download() {
          const body = JSON.stringify("");

          fetch(this.#domain.concat("/Face/App_List/"), { method: "POST", headers: this.#headers, body: body })
          .then(data => data.json())
          .then(data => {
              const applications = [];

              let index = 0;
              for (const value of Object.values(data)[index]) {
                const application = {};

                for (const key of Object.keys(data)) {
                  application[key] = data[key][index];
                }

                applications.push(new Application(application));
                index += 1
              }

              this.applications = applications;
              this.notifyObservers(this.applications);
            })
            .catch(error => console.log(error));
        }

        upload(application) {
          const body = JSON.stringify(application);

          fetch(this.#domain.concat("/Face/New_app"), { method: "POST", headers: { ...this.#headers, "Content-Length": body.length }, body: `'${body}'` })
            .then(response => response.json())
            .then(object => {
              this.notifyObservers(object);

              if (object.error === 0 || object.error === "0") {
                this.applications.push(application);
                this.notifyObservers(this.applications);
              }
            })
          }

        update(application) {
          const body = JSON.stringify(application);

          fetch(this.#domain.concat("/Face/Update_app"), { method: "POST", headers: { ...this.#headers, "Content-Length": body.length }, body: `'${body}'` })
            .then(response => response.json())
            .then(object => {
              this.notifyObservers(object)

              this.applications = this.applications.map(candidate => { if (candidate.app_id !== application.app_id) { return candidate; } return application; });
              this.notifyObservers(this.applications);
            })
        }

        // MARK: ...

        /** @type {UIApplication|undefined */
        static #shared = undefined;

        static get shared() {
          if (typeof UIApplication.#shared !== "object") {
            UIApplication.#shared = new UIApplication(false);
          }
          return UIApplication.#shared;
        }

      }

    </script>

    <script>

      const form = {
        modal: document.querySelector("div#applicationForm.modal"),

        show(application) {
          if (typeof application === "undefined") {
            this.state = form_new;
          }
          else {
            this.state = form_edit;
          }
        }
      };

      const form_new = {};
      const form_edit = {};

      const view = {
        delegate: undefined,

        table: document.querySelector("table.table"),
        modal: document.querySelector("div#applicationForm.modal"),

      };
    </script>

    <script>
      // MARK:- `UIViewController`
      class UIViewController {

        // MARK: Properties

        /** @type {number|undefined} */
        #selectedRowIndex = undefined;

        #chart = document.querySelector("canvas#interceptedRequests");

        // MARK: Constructors

        constructor(flag = true) {
          if (flag) {
            throw new Error();
          }
          view.delegate = this;

          UIApplication.shared.attachObserver(this);
          UIApplication.shared.attachObserver(UIFormViewController.shared);
          UIApplication.shared.download();

          UIFormViewController.shared.dataSource = this;
        }

        // MARK: Methods

        loadView() {
          document.body.prepend(this.addButton);

          view.modal.addEventListener("hide.bs.modal", event => view.delegate.modalDidHide(event));
          view.modal.addEventListener("show.bs.modal", event => view.delegate.modalDidShow(event));

          for (const key in { ...new Application(), " ": 0 }) {
            view.table.querySelector("thead > tr").insertAdjacentHTML("beforeend", `<th scope=col>${key}</th>`);
          }

          new Chart(this.#chart, {
            type: "bar",
            data: {
              labels: Array.from(Array(12), (number, index) => {
                let initialDate = new Date();
                initialDate = new Date(initialDate - index * 18 * 60 * 1000);

                return initialDate.toLocaleTimeString(undefined, { timeStyle: "short" });
              }).reverse(),
              datasets: [
                {
                  label: "Перехваченные запросы",
                  data: Array.from(Array(12), _ => Math.floor(Math.random() * 1000)),
                  backgroundColor: [
                    "aquamarine", "antiquewhite", "coral", "springgreen"
                  ]
                },
              ]
            }
          });
        }

        applicationDidFetch(object) {
          if (!Array.isArray(object)) {
            return;
          }

          view.table.querySelector("tbody").innerHTML = "";
          object.forEach(application => {
            const tr = document.createElement("tr")
            for (const key in application) {
              const td = document.createElement("td");
              td.innerText = application[key];
              tr.insertAdjacentElement("beforeend", td);
            }
            tr.insertAdjacentElement("beforeend", this.editButton)

            view.table.querySelector("tbody").insertAdjacentElement("beforeend", tr);
          });
          view.table.querySelectorAll("tbody > tr").forEach((tr, trIndex) => tr.addEventListener("click", event => view.delegate.tableDidClick(event, trIndex), true));
        }

        tableDidClick(event, trIndex) {
          this.#selectedRowIndex = trIndex;
          console.log(trIndex)
        }

        modalDidHide(event) {

        }

        modalDidShow(event) {

        }

        addButtonDidClick(event) {
          UIFormViewController.shared.state = new AddFormState();
          UIFormViewController.shared.present();
        }

        editButtonDidClick(event) {
          UIFormViewController.shared.state = new UpdateFormState();
          UIFormViewController.shared.present(UIApplication.shared.applications[this.#selectedRowIndex]);
        }

        // MARK: Getters

        get addButton() {
          const button = document.createElement("button");

          button.className = "btn btn-success mb-2";
          button.innerHTML = UIImage.named("plus-circle").concat("\n");
          button.innerHTML += "Добавить приложение";
          button.addEventListener("click", event => this.addButtonDidClick(event))

          return button;
        }

        get editButton() {
          const td = document.createElement("td");
          const button = document.createElement("button");

          button.className = "btn btn-primary";
          button.innerHTML = UIImage.named("pencil-square");
          button.addEventListener("click", event => this.editButtonDidClick(event))

          td.append(button);
          return td;
        }


        // MARK: ...

        /** @type {UIViewController|undefined} */
        static #shared = undefined;

        static get shared() {
          if (typeof UIViewController.#shared !== "object") {
            UIViewController.#shared = new UIViewController(false);
          }
          return UIViewController.#shared;
        }

      }
    </script>

    <script>
      class UIFormViewController {

        // MARK: Properties

        state = new AddFormState();

        form = document.querySelector("form.vstack");
        modal = new bootstrap.Modal(document.querySelector("div#applicationForm.modal"));

        // MARK: Constructors

        constructor(flag = true) {
          if (flag) {
            throw new Error();
          }
          this.loadView();
        }

        // MARK: Methods

        loadView() {
          document.querySelector("div.modal-footer").append(this.saveButton);
        }

        present(dataSource = new Application()) {
          this.form.innerHTML = "";

          dataSource["error"] = "";

          for (const key in dataSource) {
            const div = document.createElement("div");
            const label = document.createElement("label");
            const input = document.createElement("input");


            label.className = "form-label";
            label.htmlFor = key;
            label.innerText = key;

            input.className = "form-control"
            input.id = key
            input.type = "text";
            input.value = dataSource[key] ?? "";

            this.state.div(div, label, input);

            div.append(label);
            div.append(input);
            this.form.append(div);
          }
          this.modal.show();
        }

        dismiss() {
          this.modal.hide();
        }

        error(message) {
          const errorInput = this.form.querySelector("input#error");
          if (!errorInput) {
            return;
          }
          errorInput.value = this.state.message;
        }

        applicationDidFetch(object) {
          switch (object.error) {
            case "0":
            case 0:
              UIFormViewController.shared.dismiss();
              return;

            default:
              UIFormViewController.shared.error(this.state.message);
              return;
          }
        }

        saveButtonDidClick() {
          this.state.fetch(this.application);
        }

        // MARK: Getters

        get application() {
          const application = new Application();
          for (const key in application) {
            application[key] = document.querySelector("input#".concat(key)).value;
          }

          return new Application(application);
        }

        get saveButton() {
          const button = document.createElement("button");
          button.id = "saveButton";
          button.className = "btn btn-primary";
          button.type = "button";
          button.innerText = "Сохранить";
          button.addEventListener("click", event => this.saveButtonDidClick(event));

          return button;
        }

        // MARK: ...

        /** @type {UIFormViewController|undefined} */
        static #shared = undefined;

        static get shared() {
          if (typeof UIFormViewController.#shared !== "object") {
            UIFormViewController.#shared = new UIFormViewController(false);
          }
          return UIFormViewController.#shared;
        }

      }

      class FormState {
        div(div, label, input) {
          if (input.id === "error") {
            input.className = "form-control-plaintext";
            input.setAttribute("disabled", "");
            input.value = "";
          }
        }
      }

      class AddFormState extends FormState {
        fetch(application) {
          UIApplication.shared.upload(application);
        }

        div(div, label, input) {
          super.div(div, label, input);
        }

        get title() {
          return "Новое приложение";
        }

        get message() {
          return "Приложение с указанным app_id уже существует.";
        }
      }

      class UpdateFormState extends FormState {
        fetch(application) {
          UIApplication.shared.update(application);
        }

        div(div, label, input) {
          super.div(div, label, input);
          if (input.id === "app_id") {
            input.setAttribute("disabled", "");
          }
        }

        get title() {
          return "Редактирование приложения";
        }

        get message() {
          return "Приложение с указанным app_id не существует.";
        }
      }
    </script>

    <script>
      window.addEventListener("load", UIViewController.shared);
      window.addEventListener("load", UIViewController.shared.loadView.bind(UIViewController.shared));
    </script>
  </body>
</html>
