<!DOCTYPE html>
<html lang='ru'>
  <head>
    <meta charset='UTF-8' />
    <title>
      Тестовое
    </title>
    <meta content='width=device-width, initial-scale=1.0' />
    <link rel='preconnect'
      href='https://fonts.googleapis.com'
    >
    <link rel='preconnect' crossorigin
      href='https://fonts.gstatic.com'
    >
    <link rel='stylesheet'
      href='https://fonts.googleapis.com/css2?family=Golos+Text&display=swap'
    >
    <style>
      :root {
        --light-red-color: #FF3B30;
        --light-blue-color: #007AFF;
      }
    </style>
    <style>
      * {
        font: 400 16px/1.2em 'Golos Text', sans-serif;
        padding: 0; margin : 0;
        border: unset;
        transition: all 250ms linear;
      }
    </style>
    <style>
      body {
        width: 100lvw; height: 100lvh;
        display: flex;
        justify-content: center; align-items: center;
        background: #F2F2F7;
      }
      form {
        aspect-ratio: 1/.65;
        display: flex; position: relative;
        flex-wrap: wrap; flex-direction: column;
        justify-content: space-evenly;
      }
      fieldset {
        display: flex;
        justify-content: space-between;
      }
    </style>
    <style>
      button {
        padding: 1.1rem 1.45rem;
        align-self: flex-end;
        position: absolute;
        top     : 100%;
        color: #FFFF;
        background: var(--light-blue-color);
        border-radius: 2rem;
        opacity: 100%;
        cursor: pointer;
        transition: all 250ms ease;
      }
      button[disabled] {
        top: 102%;
        opacity: 0%;
        cursor: default;
      }
      input {
          font-size: 1.0625em;
          width: 41.85%;
          padding: 1.3rem 1.05rem;
          border-radius: .4375rem;
      }
      input[name='birthday'],
      input[name='email'] {
          box-sizing: border-box;
          width: 100%;
      }
      form:not([novalidate]) input:not(:focus-visible):invalid {
          outline: .0625rem var(--light-red-color) solid;
          background: #FFE9E8;
      }
    </style>
    <style>
      *:focus-visible {
        outline: .0625rem #999 solid;
      }
      *::selection,
      ::-webkit-datetime-edit-year-field:focus,
      ::-webkit-datetime-edit-month-field:focus,
      ::-webkit-datetime-edit-day-field:focus {
        color: #FFFF;
        background: var(--light-blue-color) !important;
      }
      *::placeholder {
        color: #8E8E93;
      }
    </style>
  </head>
  <body>
    <form method='get' target='_self' novalidate>
      <fieldset>
        <input id='firstName' name='firstName' type='text'
          inputmode='text'
          placeholder='Имя'
        />
        <input id='lastName' name='lastName' type='text'
          inputmode='text'
          placeholder='Фамилия'
        />
      </fieldset>
      <fieldset>
        <input id='birthday' name='birthday' type='text'
          placeholder='Дата рождения'
          onblur='
            if (!this.value) {
              this.type = `text`;
            }
          '
          onfocus='this.type = `date`;'
        />
      </fieldset>
      <fieldset>
        <input id='email' name='email' type='email'
          inputmode='email'
          placeholder='Электронная почта'
        />
      </fieldset>
      <fieldset>
        <input id='password' name='password' type='password'
          placeholder='Пароль'
        />
        <input id='password_confirmation' name='password_confirmation' type='password'
          placeholder='Подтвердите пароль'
        />
      </fieldset>
      <button id='sumbit_button' type='submit' disabled>
        Отправить
      </button>
    </form>
    <script>
      const view = {
        /** @returns {HTMLFormElement} */
        get form() {
            return document.querySelector(`body > form`);
        },
        /** @returns {HTMLInputElement} */
        get firstName() {
            return this.form.querySelector(`input[name='firstName']`);
        },
        /** @returns {HTMLInputElement} */
        get lastName() {
            return this.form.querySelector(`input[name='lastName']`);
        },
        /** @returns {HTMLInputElement} */
        get birthday() {
            return this.form.querySelector(`input[name='birthday']`);
        },
        /** @returns {HTMLInputElement} */
        get email() {
            return this.form.querySelector(`input[name='email']`);
        },
        /** @returns {HTMLInputElement} */
        get password() {
            return this.form.querySelector(`input[name='password']`);
        },
        /** @returns {HTMLInputElement} */
        get password_confirmation() {
            return this.form.querySelector(`input[name='password_confirmation']`);
        },
        /** @returns {HTMLButtonElement} */
        get submit() {
            return this.form.querySelector(`button[type='submit']`);
        }
      };
    </script>
    <script>
      /**
        * @param   {string}  string
        * @returns {boolean} .
      */
      function isEmpty(string) {
        return string.length <= 0;
      }
      /**
        * @param   {string}  character
        * @returns {boolean} .
      */
      function isDigit(character) {
        return !isNaN(parseInt(character));
      }
      /**
        * @param   {string}  character
        * @returns {boolean} .
      */
      function isLatin(character) {
        return character.toLowerCase() >= "a" && character.toLowerCase() <= "z";
      }
      /**
        * @param   {string}  string
        * @param   {number}  minLength
        * @returns {boolean} .
      */
      function isRangeUnderflow(string, minLength) {
        return string.length < minLength;
      }
      /**
        * @param   {string}  string
        * @param   {number}  maxLength
        * @returns {boolean} .
      */
      function isRangeOverflow(string, maxLength) {
        return string.length > maxLength;
      }
      /**
        * @param   {string}  string
        * @returns {boolean} .
      */
      function includesDigit(string) {
        return Array.from(string).some(isDigit);
      }
      /**
        * @param   {string}  string
        * @returns {boolean} .
      */
      function includesLatin(string) {
        return Array.from(string).some(isLatin);
      }
      /**
        * @param   {string}  target
        * @param   {RegExp}  regexp
        * @returns {boolean} .
      */
      function includesRegExp(target, regexp) {
        const matches = target.match(regexp);
        if (matches) {
          return true;
        }
        return false;
      }
      /**
        * @param   {string}  string
        * @returns {boolean} .
      */
      function isAdult(string) {
        const today = new Date();
        const userDate = new Date(string);
        let difference = today.getFullYear() - userDate.getFullYear();
        if (userDate.getMonth() < today.getMonth() && userDate.getDay() < today.getDay()) {
          difference -= 1;
        }
        if (difference < 18) {
            return false;
        }
        return true;
      }
    </script>
    <script>
      const controller = {
        launch : function() {
          view.form.addEventListener(
            "input",
            (event) => {
              event.target.setCustomValidity("");
            }
          );
          view.form.addEventListener(
            "input",
            (event) => {
              for (const field of [view.firstName, view.lastName, view.birthday, view.email, view.password, view.password_confirmation]) {
                if (!field.value) {
                  view.submit.disabled = true;
                  return;
                }
              }
              view.submit.disabled = false;
            }
          );
          view.submit.addEventListener(
            "click",
            (event) => {
              event.preventDefault();
            }
          );
          view.submit.addEventListener(
            "click", (event) => {
              const hasProblem = [
                  this.avoids.call(
                      view.firstName,
                      [
                          {
                              rule : isEmpty,
                              description : `Вам необходимо указать Ваше имя.`
                          },
                          {
                              rule : isRangeOverflow,
                              args : [32],
                              description : `Имя не может быть длинее ${32} символов.`
                          },
                          {
                              rule : includesDigit,
                              description : `Имя не может содержать цифр.`
                          },
                          {
                              rule : includesLatin,
                              description : `Имя не может содержать латиницу.`
                          },
                          {
                              rule : (firstName) => {
                                  return firstName.includes(` `);
                              },
                              description : `Имя не может содержать пробелов.`
                          }
                      ]
                  ),
                  this.avoids.call(
                      view.lastName,
                      [
                          {
                              rule : isEmpty,
                              description : `Вам необходимо указать Вашу фамилию.`
                          },
                          {
                              rule : isRangeOverflow,
                              args : [32],
                              description : `Фамилия не может быть длинее ${32} символов.`
                          },
                          {
                              rule : includesDigit,
                              description : `Фамилия не может содержать цифр.`
                          },
                          {
                              rule : includesLatin,
                              description : `Фамилия не может содержать латиницу.`
                          },
                          {
                              rule : (lastName) => {
                                  return lastName.includes(` `);
                              },
                              description : `Фамилия не может содержать пробелов.`
                          }
                      ]
                  ),
                  this.avoids.call(
                      view.birthday,
                      [
                          {
                              rule : (userDate) => {
                                  return !isAdult(userDate);
                              },
                              description : `Возраст регистрации составляет от 18 лет.`
                          }
                      ]
                  ),
                  this.avoids.call(
                      view.email,
                      [
                          {
                              rule : isEmpty,
                              description : `Вам необходимо указать Вашу электронную почту.`
                          },
                          {
                              rule : (userEmail) => {
                                  return !userEmail.includes(`@`);
                              },
                              description : `Электронный адрес должен содержать символ '@'.`
                          },
                          {
                              rule : (userEmail) => {
                                  return userEmail.match(/@/g).length !== 1;
                              },
                              description : `Электронный адрес должен содержать единственный символ '@'.`
                          },
                          {
                              rule : (userEmail) => {
                                  return userEmail
                                      .slice(
                                          userEmail.lastIndexOf(`@`) + 1,
                                          userEmail.length
                                      )
                                      .length === 0;
                              },
                              description : `Вам необходимо указать домен после символа '@'.`
                          }
                      ]
                  ),
                  this.avoids.call(
                      view.password,
                      [
                          {
                              rule : isEmpty,
                              description : `Вам необходимо указать пароль.`
                          },
                          {
                              rule : (userPassword) => {
                                  return userPassword !== view.password_confirmation.value;
                              },
                              description : `Введённые пароли должны совпадать.`
                          },
                          {
                              rule : isRangeUnderflow,
                              args : [8],
                              description : `Минимальная длина пароля составляет ${8} символов.`
                          },
                          {
                              rule : (userPassword) => {
                                  return !includesDigit(userPassword);
                              },
                              description : `Пароль должен включать в себя минимум 1 цифру.`
                          },
                          {
                              rule : (userPassword) => {
                                  const matches = userPassword.match(/[a-z]/g);
                                  if (matches) {
                                      return false;
                                  }
                                  return true;
                              },
                              description : `Пароль должен включать в себя минимум 1 строчную латинскую букву.`
                          },
                          {
                              rule : (userPassword) => {
                                  const matches = userPassword.match(/[A-Z]/g);
                                  if (matches) {
                                      return false;
                                  }
                                  return true;
                              },
                              description : `Пароль должен включать в себя минимум 1 заглавную латинскую букву.`
                          },
                      ]
                  ),
              ]
                  .some(value => value === false);
              if (hasProblem) {
                view.form.noValidate = false;
                view.form.reportValidity();
              }
              else {
                view.form.submit();
              }
            }
          );
        },
        /**
          * @param   {any[]} conditions
          * @returns {boolean}
        */
        avoids: function(conditions) {
          const checks = [];
          for (let i = 0; i < conditions.length; ++i) {
              if (conditions[i].args) {
                  checks.push(
                      conditions[i].rule.apply(
                          null,
                          conditions[i].args
                              .concat(this.value)
                              .reverse()
                      )
                  );
              }
              else {
                  checks.push(
                      conditions[i].rule.apply(
                          null,
                          [this.value]
                      )
                  );
              }
              if (checks.includes(true)) {
                this.setCustomValidity(conditions[i].description);
                break;
              }
          }
          return checks.every(check => check === false);
        }
      };
      window.addEventListener("load", controller.launch.bind(controller));
    </script>
  </body>
</html>
